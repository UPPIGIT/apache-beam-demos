# -*- coding: utf-8 -*-
"""Tumbling_Processor.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1JYIli7nXqe9dc6F6S5Pd3M8_0n1vu0ST
"""

pip install apache_beam

pip install google-cloud-pubsub

import apache_beam as beam
from apache_beam.options.pipeline_options import PipelineOptions,StandardOptions
import os
from apache_beam import window
from apache_beam.transforms.combiners import Count


serviceAccount = '/content/vivid-now-271806-e22933a07e8a.json'
os.environ["GOOGLE_APPLICATION_CREDENTIALS"]= serviceAccount

input_subscription = 'projects/vivid-now-271806/subscriptions/movie_subscription'

options= PipelineOptions()
options.view_as(StandardOptions).streaming= True

p = beam.Pipeline(options=options)

comedy_movies = 'projects/vivid-now-271806/topics/comedy_movies'

pubsub_pipeline = (
    p
    | 'Read from pubsub topic' >> beam.io.ReadFromPubSub(subscription= input_subscription)
    | 'Split the records by comma' >> beam.Map(lambda row: row.decode("utf-8").split(','))
    | 'Form Key Value Pair' >> beam.Map(lambda row: (row[1],int(row[2])))
    | 'Window' >> beam.WindowInto(window.FixedWindows(10))
    | 'Count the ratings' >> Count.PerKey()
    | 'Converting to byte String' >> beam.Map(lambda row: (''.join(row).encode('utf-8')) )
    | 'Publish to output topic' >> beam.io.WriteToPubSub(comedy_movies)
)
result = p.run()
result.wait_until_finish()